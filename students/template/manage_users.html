<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Manage Users</title>
    <link href="mainstyle.css" rel="stylesheet">
    <link href="../../resources/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Function to show/hide FA ID column
            function toggleFaIdColumn(userType) {
                if (userType === 'student' || userType === 'fa') {
                    $('#userTable th.fa-id-col, #userTable td.fa-id-col').show();
                } else {
                    $('#userTable th.fa-id-col, #userTable td.fa-id-col').hide();
                }
            }

            // On page load, hide FA ID column by default
            toggleFaIdColumn($('#userType').val());

            // Show/hide student filters and FA ID column
            $('#userType').change(function () {
                const userType = $(this).val();
                toggleFaIdColumn(userType);

                if (userType === 'student') {
                    $('#studentFilters').show();
                    $('#faFilters').hide();
                    fetchStudentFilterOptions();
                } else if (userType === 'fa') {
                    $('#studentFilters').hide();
                    $('#faFilters').show();
                } else {
                    $('#studentFilters').hide();
                    $('#faFilters').hide();
                    fetchUsers(); // fetch for hod/hc
                }
            });

            // Fetch users when student filter is applied
            $('#applyStudentFilter').click(function () {
                fetchUsers();
            });

            // Fetch users when fa filter is applied
            $('#applyFaFilter').click(function () {
                fetchUsers();
            });

            function fetchStudentFilterOptions() {
                $.ajax({
                    url: 'fetch_student_filter_options.php',
                    method: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        // Populate department dropdown
                        const deptSelect = $('#studentDept');
                        deptSelect.empty().append('<option value="">All Departments</option>');
                        data.departments.forEach(function (dept) {
                            deptSelect.append(`<option value="${dept}">${dept}</option>`);
                        });

                        // Populate year dropdown
                        const yearSelect = $('#studentYear');
                        yearSelect.empty().append('<option value="">All Years</option>');
                        data.years.forEach(function (year) {
                            yearSelect.append(`<option value="${year}">${year}</option>`);
                        });

                        // Populate section dropdown
                        const sectionSelect = $('#studentSection');
                        sectionSelect.empty().append('<option value="">All Sections</option>');
                        data.sections.forEach(function (section) {
                            sectionSelect.append(`<option value="${section}">${section}</option>`);
                        });
                    }
                });
            }

            function fetchUsers() {
                const userType = $('#userType').val();
                if (!userType) {
                    $('#userTable tbody').empty();
                    return;
                }

                let data = { userType: userType };
                if (userType === 'student') {
                    data.dept = $('#studentDept').val();
                    data.year = $('#studentYear').val();
                    data.section = $('#studentSection').val();
                    data.name = $('#studentName').val();
                }
                if (userType === 'fa') {
                    data.name = $('#faName').val();
                }

                $.ajax({
                    url: 'fetch_user_details.php',
                    method: 'POST',
                    data: data,
                    success: function (data) {
                        let users = [];
                        try {
                            users = JSON.parse(data);
                        } catch (e) {
                            users = [];
                        }
                        const userTable = $('#userTable tbody');
                        userTable.empty();

                        if (Array.isArray(users) && users.length > 0) {
                            users.forEach(function (user) {
                                let row = `<tr>
                                    <td>${user.name}</td>
                                    <td>${user.email}</td>
                                    <td>${user.department || user.role || ''}</td>`;
                                if (userType === 'student' || userType === 'fa') {
                                    row += `<td class="fa-id-col">${user.fa_id || ''}</td>`;
                                }
                                row += `</tr>`;
                                userTable.append(row);
                            });
                        } else {
                            let colspan = (userType === 'student' || userType === 'fa') ? 4 : 3;
                            userTable.append(`<tr><td colspan="${colspan}">No users found</td></tr>`);
                        }
                    },
                    error: function () {
                        alert('Error fetching user details.');
                    }
                });
            }

            function fetchAllFAs(callback) {
                $.ajax({
                    url: 'fetch_user_details.php',
                    method: 'POST',
                    data: { userType: 'fa' },
                    success: function (data) {
                        let fas = [];
                        try {
                            fas = JSON.parse(data);
                        } catch (e) {
                            fas = [];
                        }
                        callback(fas);
                    }
                });
            }

            // Change FA for filtered students
            $('#changeFaFiltered').click(function () {
                const dept = $('#studentDept').val();
                const year = $('#studentYear').val();
                const section = $('#studentSection').val();
                const newFaId = $('#newFaSelectFiltered').val();

                if (!dept || !year || !section || !newFaId) {
                    alert('Please select Department, Year, Section, and New FA.');
                    return;
                }

                if (confirm('Are you sure you want to change the FA for all students matching these filters?')) {
                    $.ajax({
                        url: 'update_fa_id.php',
                        method: 'POST',
                        data: {
                            dept: dept,
                            year: year,
                            section: section,
                            new_fa_id: newFaId,
                            mode: 'filtered'
                        },
                        success: function (data) {
                            let res = {};
                            try { res = JSON.parse(data); } catch (e) { res = {}; }
                            if (res.success) {
                                alert('FA updated for all filtered students!');
                                fetchUsers();
                            } else {
                                alert('Failed to update FA.');
                            }
                        },
                        error: function () {
                            alert('Error updating FA.');
                        }
                    });
                }
            });

            function checkShowChangeFa() {
                // Show the change FA option only if all three filters are selected
                const dept = $('#studentDept').val();
                const year = $('#studentYear').val();
                const section = $('#studentSection').val();
                if (dept && year && section) {
                    $('#changeFaContainer').show();
                    populateFaDropdownFiltered();
                } else {
                    $('#changeFaContainer').hide();
                }
            }

            // Call this function when any student filter changes
            $('#studentDept, #studentYear, #studentSection').change(checkShowChangeFa);

            // Also call after filters are populated
            $('#applyStudentFilter').click(function () {
                fetchUsers();
                checkShowChangeFa();
            });

            // Populate FA dropdown for filtered change
            function populateFaDropdownFiltered() {
                $.ajax({
                    url: 'fetch_user_details.php',
                    method: 'POST',
                    data: { userType: 'fa' },
                    success: function (data) {
                        let fas = [];
                        try { fas = JSON.parse(data); } catch (e) { fas = []; }
                        let options = fas.map(fa => `<option value="${fa.fa_id}">${fa.name}</option>`).join('');
                        $('#newFaSelectFiltered').html('<option value="">Select New FA</option>' + options);
                    }
                });
            }

            // Handle the change FA for filtered students
            $('#changeFaFiltered').click(function () {
                const dept = $('#studentDept').val();
                const year = $('#studentYear').val();
                const section = $('#studentSection').val();
                const newFaId = $('#newFaSelectFiltered').val();

                if (!dept || !year || !section || !newFaId) {
                    alert('Please select Department, Year, Section, and New FA.');
                    return;
                }

                if (!confirm('Are you sure you want to change the FA for all students matching these filters?')) return;

                $.ajax({
                    url: 'update_fa_id.php',
                    method: 'POST',
                    data: {
                        dept: dept,
                        year: year,
                        section: section,
                        new_fa_id: newFaId,
                        mode: 'filtered'
                    },
                    success: function (data) {
                        let res = {};
                        try { res = JSON.parse(data); } catch (e) { res = {}; }
                        if (res.success) {
                            alert('FA updated for all filtered students!');
                            fetchUsers();
                        } else {
                            alert('Failed to update FA.');
                        }
                    },
                    error: function () {
                        alert('Error updating FA.');
                    }
                });
            });

            
            // Populate FA dropdowns for all students change
            function populateFaDropdowns() {
                $.ajax({
                    url: 'fetch_user_details.php',
                    method: 'POST',
                    data: { userType: 'fa' },
                    success: function (data) {
                        let fas = [];
                        try { fas = JSON.parse(data); } catch (e) { fas = []; }
                        let options = fas.map(fa => `<option value="${fa.fa_id}">${fa.name}</option>`).join('');
                        $('#oldFaSelect, #newFaSelect').html('<option value="">Select FA</option>' + options);
                    }
                });
            }

            // Initial population of FA dropdowns
            populateFaDropdowns();
        });
    </script>
</head>

<body class="nav-fixed">
    <form id="manageUsersForm" name="manageUsersForm" method="post">
        <nav class="topnav navbar navbar-expand shadow justify-content-between justify-content-sm-start navbar-light bg-white" id="sidenavAccordion">
            <a class="navbar-brand" href="#">
                <img src="../../resources/Image/srmist.png" alt="SRM Logo" />
                <br><font style="font-size: 9pt;">Admin Portal</font>
            </a>
            <span class="text-custom d-none d-sm-block"><b>SRM Admin Dashboard</b></span>
        </nav>

        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sidenav shadow-right sidenav-light">
                    <div class="sidenav-menu">
                        <a class="nav-link" href="HRDSystemAdmin.html">Home</a>
                        <a class="nav-link" href="manage_users.html">Manage Users</a>
                        <a class="nav-link" href="generate_report.html">Generate Report</a>
                        <a class="nav-link" href="#systemStats">System Stats</a>
                        <a class="nav-link" data-toggle="modal" data-target="#logoutModal">Logout</a>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container">
                        <h1 class="mt-4">Manage Users</h1>

                        <!-- User Type Dropdown -->
                        <div class="card mb-4">
                            <div class="card-header">Select User Type</div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="userType">User Type:</label>
                                    <select id="userType" class="form-control">
                                        <option value="">Select User Type</option>
                                        <option value="student">Student</option>
                                        <option value="fa">Faculty Advisor</option>
                                        <option value="hod">HOD</option>
                                        <option value="hc">Hostel Coordinator</option>
                                    </select>
                                </div>

                                <!-- Student Filters (hidden by default) -->
                                <div id="studentFilters" style="display:none;">
                                    <div class="form-row">
                                        <div class="form-group col-md-3">
                                            <label for="studentDept">Department:</label>
                                            <select id="studentDept" class="form-control">
                                                <option value="">All Departments</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-3">
                                            <label for="studentYear">Year:</label>
                                            <select id="studentYear" class="form-control">
                                                <option value="">All Years</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-3">
                                            <label for="studentSection">Section:</label>
                                            <select id="studentSection" class="form-control">
                                                <option value="">All Sections</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-3">
                                            <label for="studentName">Student Name:</label>
                                            <input type="text" id="studentName" class="form-control" placeholder="Search by name">
                                        </div>
                                    </div>
                                    <button type="button" id="applyStudentFilter" class="btn btn-primary">Apply Filter</button>

                                    <!-- Change FA for Filtered Students (hidden by default) -->
                                    <div id="changeFaContainer" style="display:none; margin-top:10px;">
                                        <div class="form-row align-items-end">
                                            <div class="form-group col-md-8">
                                                <label for="newFaSelectFiltered">Select New Faculty Advisor:</label>
                                                <select id="newFaSelectFiltered" class="form-control"></select>
                                            </div>
                                            <div class="form-group col-md-4">
                                                <button type="button" id="changeFaFiltered" class="btn btn-warning">Change FA for Filtered Students</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Faculty Advisor Filter (hidden by default) -->
                                <div id="faFilters" style="display:none;">
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="faName">Faculty Advisor Name:</label>
                                            <input type="text" id="faName" class="form-control" placeholder="Search by name">
                                        </div>
                                    </div>
                                    <button type="button" id="applyFaFilter" class="btn btn-primary">Apply Filter</button>
                                </div>
                            </div>
                        </div>

                        <!-- User Details Table -->
                        <table class="table table-bordered" id="userTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role/Dept</th>
                                    <th class="fa-id-col">FA ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- User data will be dynamically populated here -->
                            </tbody>
                        </table>

                    
                    </div>
                </main>
            </div>
        </div>
    </form>
</body>

</html>